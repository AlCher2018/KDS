История изменений KDSService.dll - сервис КДС (библиотечный файл) (RAM 31 Mb)
===================================================================

Версия 1.0.2.0
--------------
2017-11-28 Фильтрация и группировка заказов для конкретного клиента осуществляется сервисом. Для этого клиент передает сервису условия фильтрации (по цеху и отображаемому статусу) и группировки заказов (по времени или по заказам). Также, клиент передает сервису Id заказа и блюда, начиная с которых необходимо получить данные, направление просмотра (вперед/назад) и приблизительное количество позиций заказов. Это позволяет ограничить объем данных, передаваемых по сети.
Служба возвращает клиенту не только фрагмент набора заказов, но и признаки наличия данных перед и после этого фрагмента (для показа кнопок листания назад/вперед соотв.), признак появления нового заказа (для проигрывания звукового файла).
Обновлена библиотека IntegraLib, проведен рефакторинг кода. 
Запуск сервиса, как Win-службы, защищен psw-файлом. Внимание!!! Файл ОБЯЗАТЕЛЬНО должен иметь имя KDSService.psw !!!
2017-11-30 При включенном флажке двухэтапного состояния Готово/ПодтвГотово, служба автоматически переводит статус блюда из Готово в ПодтвГотово, если период этого перехода не равен 0. Для этого в файле KDSServiceAppSettings.config кдс-службы есть элемент AutoGotoReadyConfirmPeriod:
  <!-- Время, в СЕКУНДАХ, автоматического перехода из Готово в ПодтвГотово, при включенном ПодтвГотово (UseReadyConfirmedState = true). Если отсутствует или равно 0, то автоматического перехода не будет. -->
  <add key="AutoGotoReadyConfirmPeriod" value="0"/>


Версия 1.0.1.2
--------------
2017-10-04 Пользовательские настройки разнесены в несколько файлов:
 - KDSServiceAppSettings.config - параметры работы приложения;
 - KDSServiceDBConnection.config - параметры доступа к базе данных (хост, имя БД, авторизация).
В файле KDSService.config остались настройки внешних библиотек: логирование, работа с БД.
Сетевые параметры службы для работы с клиентами по TCP (протокол, адрес, порт, контракт) зашиты в софт.
Тектовые документы, напр. данный файл, теперь находятся в папке docs.


Версия 1.0.1.1
--------------
2017-09-29 Исправлен баг при подсчете количества готовящихся блюд по цехам, что приводило к неправильной работе автостарта готовки. Сейчас количество порций округляется до большего целого и автостарт происходит без учета количества порций блюда. Например, пул цеха - 7 порций, в настоящее время готовится 6 и появляется позиция на этом цехе в 2,5 порции (которая считается за 3 порции). Эта позиция автоматически переходит в состояние Готовится и количество готовящихся порций становится 10. И пока это количество не станет меньше 7, новые позиции на этом цехе стартовать автоматически не будут.


Версия 1.0.1.0
--------------
2017-09-12 Существенно переделана процедура чтения данных из БД с целью уменьшить время чтения, которое, напр. на лапше Бессарабка, Блокбастер, составляло, 3,5-4 секунды!!! 
2017-09-27 Исправлен баг, вызывавший ошибку формирования SQL-запроса для чтения заказов из БД при использовании параметра UnusedDepartments.


2017-09-08 Внесены изменения в config-файл: раздел
    <targets>
      <target name="fileTrace" xsi:type="File" fileName="Logs/KDSService.log" layout="${date}|${level}|${message}"/>
    </targets>
заменен полностью разделом
    <targets async="true">
      <target name="fileTrace" xsi:type="File" fileName="Logs/KDSService.log" layout="${date}|${level}|${message}"
              archiveEvery = "Hour" archiveFileName = "Logs/KDSService {#}.txt" archiveNumbering = "Date" archiveDateFormat="yyyyMMdd HH\h"
              concurrentWrites="false" keepFileOpen="true"/>
    </targets>
Эти изменения позволяют:
- делать записи в лог асинхронно;
- держать файл журнала постоянно открытым;
- каждый час сбрасывать журнал в архив (т.е. за сутки будет 24 файла), уменьшая таким образом файл журнала.


Версия 1.0.0.9
--------------
2017-09-07 В лог добавлена запись изменения статуса заказа при проверке статуса заказа и всех блюд, когда изменяется статус блюда. 
Служба может менять статус заказа, когда клиент меняет статус позиций. Когда статус ВСЕХ позиций и статус заказа не совпадают, то служба меняет статус заказа на статус всех позиций, записывает новый статус в БД и в лог. Во время этой операции в версии 1.0.0.7 наблюдались задержки (по логу) до трех минут.
Проверка статуса заказа и всех разрешенных блюд производится в двух местах: при регулярном чтении заказа с блюдами из БД (частота - 1 сек) и при изменении статуса любой позиции. В первом случае запись в лог производилась, во втором - нет. Это исправление должно помочь при анализе задержек во время записи нового статуса заказа в БД.


Версия 1.0.0.8
--------------
2017-08-30 Изменена работа с логированием:
- в NLog (раздел config-файла) удален журнал dbCommandTracer (fileName="Logs/KDSDBCommands.log"), все сообщения будут писаться в один файл Logs/KDSService.log, из config-файла удален элемент SingleClientSvcLog;
- в config-файл добавлен элемент TraceOrdersDetails для подробного логирования действий при чтении данных из БД;
- элемент IsLogUserAction переименован в IsLogClientAction;
- при вызове клиентами интерфейсных методов, в лог записывается имя компьютера клиента, который обращается к службе (для этого изменены все контракты интерфейсов службы). Запись в лог вызова интерфейсных методов происходит только при установленом в конфиге флаге IsLogClientAction;
- при включенной детализации логирования заказов (TraceOrdersDetails) в лог пишется Id и номер заказа, разделенные "/";
2017-08-30 Изменена процедура обновления статуса вчерашних невыданных заказов (с 0,1,2 на 9, элемент config-файла TimeOfAutoCloseYesterdayOrders) для случая непрерывной работы в течение нескольких суток - процедура должна срабатывать каждые сутки в указанное время.
2017-08-31 Изменена процедура выборки заказов из БД для работы. Первоначально выборка осуществлялась по двум критериям: по дате создания заказа (поле CreateDate) и по статусу заказа. Но блюда могут добавляться и в заказы с терминальным статусом (то есть те, которые НЕ отображаются на КДСах), напр. в уже Выданные. Поэтому был изменен алгоритм выборки заказов: теперь в фильтре будут использоваться дата создания и статус БЛЮДА, а не заказа. 
2017-08-31 Оптимизирована выборка заказов из БД: происходит в два этапа, т.к. выборка осуществляется по блюдам, а не по заказам, это увеличивает время выборки. Поэтому сначала из базы данных выбираются все заказы за последние 5 дней, а потом в них анализируются блюда, для определения того, какие заказы должны выходить на КДСы.
2017-09-01 15:55 Исправлен небольшой баг: когда в _выданный_ (OrderStatusId=3) заказ добавляется блюдо, то обновлялось только поле OrderStatusId (для КДС), а поле QueueStatusId оставалось = 2, т.е. такой заказ на КДСе появлялся, а на очереди - нет. Сейчас обновляется и поле QueueStatusId для очереди заказов.


Версия 1.0.0.7
--------------
2017-08-01 Обновлена логика работы со ВЧЕРАШНИМИ заказами. В настоящее время, вчерашние заказы, т.е. те, у которых дата создания меньше начала текущего дня (полночь), НЕ отображаются на КДСе, вне зависимости от их статуса. Т.е. заказ, созданный в 23:59:50, через 10 секунд пропадет с экранов КДСов, несмотря на то, что он может только готовиться, и перевести его в статус Готов или Выдан с КДС уже будет невозможно.
Однако:
	1. Можно указать промежуток времени (в часах), который отсчитывается назад от полуночи и заказы, созданные в этом промежутке, НЕ БУДУТ считаться вчерашними, следовательно БУДУТ отображаться на КДСе и МОЖНО будет изменять из статус. Для этого в config-файл добавлен новый элемент:
    <!-- период времени назад (в часах) от полуночи, созданные в течение которого ВЧЕРАШНИЕ заказы БУДУТ отображаться на КДСе -->
    <add key="MidnightShiftShowYesterdayOrders" value="1.5"/>
	Например, для указанного выше значения - 1,5 часа, заказы, созданные ВЧЕРА ПОСЛЕ 22ч30мин БУДУТ отображаться на КДСе СЕГОДНЯ. А заказы, созданные вчера ДО 22ч30мин - НЕ БУДУТ отображаться на КДСе.
	Если элемент в config-файле не указан (или закомментирован), то его значение равно 0.
	2. Можно АВТОМАТИЧЕСКИ изменить статус вчерашних, НЕВЫДАННЫХ заказов на такой, который не отображается на КДСах. 
	Для этого в config-файле имеется элемент:
    <!-- время суток, когда НЕВЫДАННЫЕ вчерашние заказы (StatusId < 3) переводятся в статус YesterdayNotTook(=9) -->
    <!--<add key="TimeOfAutoCloseYesterdayOrders" value="07:00:00"/>-->
	Например, для указанного выше значения (07:00:00), при наступлении 7 часов утра (или позже, когда будет запущен КДС-сервис), для всех вчерашних, невыданных заказов в БД будет записан статус 9, который НЕ отображается на КДС.
	При определении вчерашнего заказа, учитывается и п.1. Т.е. заказы, созданные вчера ДО 22ч30мин (из примера п.1) БУДУТ переведены в статус ВчерашнийНеЗабран и исчезнут сегодня после 7 часов утра с экранов КДСов. А заказы, созданные вчера ПОСЛЕ 22ч30мин, НЕ будут сегодня автоматически переведены в другой статус и останутся на экранах КДСов.
	Если элемент в config-файле не указан (или закомментирован), то вчерашние, невыданные заказы не будут автоматически изменять свой статус.


Версия 1.0.0.6
--------------
2017-07-24 Удалена проверка, является ли позиция заказа блюдом, при попытке автостарта приготовления данной позиции. Сейчас автостарт осуществляется для любой позиции заказа, независимо блюдо это или ингредиент.
Лог запросов к БД (KDSDBCommands.log) сейчас пишется в папку Logs приложения.

Версия 1.0.0.5
--------------
2017-07-18 Продолжается поиск решения проблемы синхронизации состояний блюд/заказов, при которой происходит возврат в предыдущее состояние.
В данной версии добавлена блокировка заказа на службе от изменения по таймеру при запросе от клиента на изменение состояния.
Для одновременного логирования работы службы и клиента в config-файле есть элемент
<add key="SingleClientSvcLog" value="true"/>
Если значение true, то создается файл c:\KDSDBCommands.log, в который будет записываться трассировочная информация от службы.


Версия 1.0.0.4
--------------
2017-07-14 Исправлена ошибка, когда при записи с КДСа нового состояния блюда в БД, другой программный поток (периодический опрос заказов) возвращает это блюд в предыдущее состояние. Чем медленнее происходит фиксация нового значения в MS SQL Server и чем *меньше* заказов, тем чаще возникает данная ошибка. На экране КДСа это проявлялось как неизменение состояния блюда (очень быстро происходила перезапись на предыдущее значение) или как видимое изменение, а потом восстановление.


Версия 1.0.0.3
--------------
2017-07-11 Добавлены дополнительные проверки значений даты при записи в статистические таблицы.
В файл KDSService.config добавлен элемент <add key="UnusedDepartments" value=""/> - список (через запятую) Id цехов (направлений печати), которые не должны отображаться на КДСах.
2017-07-12 Изменен код для корректного отображения заказов в случае двухэтапного перехода в состояние Готов.

Версия 1.0.0.2
--------------
2017-07-10 В лог добавлено больше отладочной информации, особенно для операций записи в БД. 
!!!! Важно, чтобы элемент <add key="IsWriteTraceMessages" value="true"/> имел значение True !!!!


Версия 1.0.0.1
--------------
2017-07-03 Добавлена возможность записи в лог действий пользователя, напр. изменение статуса блюда/заказа (префикс сообщения - userAct). При инициализации приложения в лог записывается номер запущенной версии.


Версия 1.0.0.0
--------------
2017-06-27 Функционал КДС собран в отдельный библиотечный файл для хостинга в любом приложении (консольное приложение, Windows-служба).
